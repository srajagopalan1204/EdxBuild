<!doctype html><meta charset="utf-8" />
<title>Line Entry Options ‚Äì SOP Player</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root{
    --bg:#f7f7fb;
    --card:#fff;
    --ink:#111;
    --muted:#6b7280;
    --line:#e5e7eb;
    --brand:#0b5fff;
    --brand-soft:rgba(11,95,255,.09);
    --brand-ink:#fff;
    --danger:#b91c1c;
    --danger-soft:rgba(185,28,28,.08);
    --radius:16px;
    --shadow:0 18px 45px rgba(15,23,42,.18);
    --shadow-soft:0 8px 20px rgba(15,23,42,.12);
    --shadow-sm:0 2px 8px rgba(15,23,42,.10);
    --navh:52px;
    --maxw:1280px;
  }
  *{box-sizing:border-box;}
  html,body{
    margin:0;
    padding:0;
    font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
    background:radial-gradient(circle at top,#e0edff 0,#f7f7fb 45%,#f9fafb 100%);
    color:var(--ink);
    min-height:100vh;
  }
  body{
    display:flex;
    flex-direction:column;
    align-items:center;
    padding:16px;
  }
  .wrap{
    max-width:var(--maxw);
    margin:auto;
    width:100%;
    background:linear-gradient(135deg,#f9fafb 0,#f3f4ff 28%,#eef2ff 60%,#f9fafb 100%);
    border-radius:calc(var(--radius) + 4px);
    box-shadow:var(--shadow);
    overflow:hidden;
    border:1px solid rgba(148,163,184,.4);
  }
  header.appbar{
    display:flex;
    align-items:center;
    justify-content:space-between;
    padding:12px 18px;
    background:radial-gradient(circle at top left,#2563eb 0,#0b5fff 35%,#0f172a 100%);
    color:#eff6ff;
    box-shadow:0 3px 12px rgba(15,23,42,.45);
    position:relative;
    z-index:2;
  }
  .brand-left{
    display:flex;
    align-items:center;
    gap:10px;
  }
  .logo-badge{
    width:28px;
    height:28px;
    border-radius:999px;
    background:conic-gradient(from 200deg,#e5e7eb,#0ea5e9,#22c55e,#eab308,#e5e7eb);
    padding:2px;
    box-shadow:0 0 0 1px rgba(15,23,42,.45);
  }
  .logo-badge-inner{
    width:100%;
    height:100%;
    border-radius:999px;
    background:#020617;
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:14px;
    font-weight:700;
    letter-spacing:.05em;
    color:#e5e7eb;
  }
  .brand-text h1{
    margin:0;
    font-size:16px;
    font-weight:600;
    letter-spacing:.03em;
    text-transform:uppercase;
  }
  .brand-text p{
    margin:0;
    font-size:12px;
    opacity:.85;
  }
  .app-actions{
    display:flex;
    align-items:center;
    gap:10px;
  }
  .pill-status{
    font-size:11px;
    padding:4px 9px;
    border-radius:999px;
    background:rgba(15,23,42,.30);
    border:1px solid rgba(191,219,254,.6);
    display:flex;
    align-items:center;
    gap:6px;
  }
  .pill-dot{
    width:7px;
    height:7px;
    border-radius:999px;
    background:#22c55e;
    box-shadow:0 0 0 3px rgba(34,197,94,.25);
  }
  .pill-status span{
    opacity:.9;
  }
  .nav-buttons{
    display:flex;
    align-items:center;
    gap:6px;
  }
  .nav-btn{
    border-radius:999px;
    border:1px solid rgba(148,163,184,.65);
    background:rgba(15,23,42,.3);
    color:#e5e7eb;
    padding:4px 11px;
    font-size:11px;
    display:inline-flex;
    align-items:center;
    gap:6px;
    cursor:pointer;
    transition:all .15s ease-out;
    box-shadow:var(--shadow-sm);
    text-decoration:none;
  }
  .nav-btn span.icon{
    font-size:13px;
    opacity:.9;
  }
  .nav-btn:hover{
    background:rgba(15,23,42,.65);
    border-color:#bfdbfe;
    transform:translateY(-1px);
  }
  .nav-btn.primary{
    background:#eff6ff;
    color:#0b1120;
    border-color:#bfdbfe;
  }
  .nav-btn.primary:hover{
    background:#dbeafe;
  }
  .nav-btn.danger{
    background:#fecaca1f;
    border-color:#fecaca66;
    color:#fee2e2;
  }
  .nav-btn.danger:hover{
    background:#b91c1c;
    border-color:#fecaca;
  }

  .main-layout{
    display:grid;
    grid-template-columns: minmax(0, 1.15fr) minmax(0, .9fr);
    gap:14px;
    padding:14px 18px 16px;
  }
  .left-panel,.right-panel{
    border-radius:var(--radius);
    background:rgba(15,23,42,.02);
    border:1px solid rgba(148,163,184,.35);
    box-shadow:0 10px 30px rgba(15,23,42,.14);
    overflow:hidden;
    position:relative;
  }
  .left-panel{
    background:radial-gradient(circle at top left,#dbeafe 0,#eef2ff 35%,#f9fafb 100%);
  }
  .right-panel{
    background:radial-gradient(circle at top right,#e0f2fe 0,#f9fafb 40%,#eef2ff 100%);
  }
  .frame-img-wrap{
    position:relative;
    padding:14px 14px 12px;
  }
  .frame-img-ghost{
    position:absolute;
    inset:8px 14px auto 18px;
    border-radius:12px;
    background:radial-gradient(circle at top left,rgba(129,140,248,.45),rgba(30,64,175,.15),rgba(15,23,42,.50));
    opacity:.55;
    filter:blur(10px);
    z-index:0;
  }
  .frame-img-inner{
    position:relative;
    background:#020617;
    border-radius:12px;
    padding:10px;
    box-shadow:0 12px 30px rgba(15,23,42,.65);
    z-index:1;
  }
  .frame-img-inner img{
    width:100%;
    border-radius:8px;
    display:block;
  }
  .frame-img-caption{
    margin-top:6px;
    font-size:11px;
    color:#cbd5f5;
    display:flex;
    justify-content:space-between;
    align-items:center;
  }
  .frame-img-caption span.icon{
    font-size:12px;
    opacity:.8;
  }

  .frame-meta-bar{
    border-top:1px solid rgba(148,163,184,.45);
    background:linear-gradient(90deg,rgba(15,23,42,.88),rgba(30,64,175,.98));
    padding:7px 12px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:8px;
    color:#e5e7eb;
  }
  .meta-left{
    display:flex;
    align-items:center;
    gap:8px;
    font-size:11px;
  }
  .badge{
    border-radius:999px;
    padding:2px 8px;
    border:1px solid rgba(191,219,254,.7);
    background:rgba(15,23,42,.55);
    display:inline-flex;
    align-items:center;
    gap:5px;
  }
  .badge .dot{
    width:6px;
    height:6px;
    border-radius:999px;
    background:#4ade80;
  }
  .meta-right{
    font-size:11px;
    opacity:.85;
    display:flex;
    gap:12px;
    align-items:center;
  }

  .right-panel-inner{
    padding:12px 13px 10px;
    display:flex;
    flex-direction:column;
    gap:9px;
  }
  .crumbs{
    font-size:11px;
    color:var(--muted);
    display:flex;
    align-items:center;
    gap:4px;
  }
  .crumbs span{
    display:inline-flex;
    align-items:center;
  }
  .crumbs .step-code-pill{
    border-radius:999px;
    padding:2px 8px;
    background:rgba(37,99,235,.08);
    color:#1d4ed8;
    font-weight:500;
    border:1px solid rgba(129,140,248,.6);
  }
  .crumbs .sep{
    opacity:.55;
  }

  .title-row{
    display:flex;
    justify-content:space-between;
    align-items:flex-start;
    gap:8px;
  }
  .title-main{
    font-size:15px;
    font-weight:600;
    letter-spacing:.01em;
    line-height:1.3;
    color:#0f172a;
  }
  .title-tag{
    font-size:10px;
    padding:3px 7px;
    border-radius:999px;
    background:rgba(30,64,175,.06);
    border:1px solid rgba(129,140,248,.5);
    color:#1d4ed8;
    display:inline-flex;
    align-items:center;
    gap:4px;
  }
  .title-tag span.icon{
    font-size:11px;
  }

  .narr-box{
    border-radius:12px;
    border:1px solid rgba(148,163,184,.5);
    background:rgba(248,250,252,.9);
    padding:9px 10px 10px;
    box-shadow:0 6px 18px rgba(15,23,42,.10);
  }
  .narr-box h3{
    margin:0 0 4px;
    font-size:11px;
    text-transform:uppercase;
    letter-spacing:.08em;
    color:#64748b;
  }
  .narr-box p{
    margin:0;
    font-size:12px;
    line-height:1.45;
    color:#0f172a;
  }

  .narr-secondary{
    margin-top:6px;
    border-radius:10px;
    padding:8px 9px;
    border:1px dashed rgba(148,163,184,.7);
    background:rgba(239,246,255,.85);
    font-size:11px;
    color:#1e293b;
  }
  .narr-secondary strong{
    font-weight:600;
    color:#0f172a;
  }

  .uap-banner{
    margin-top:6px;
    border-radius:10px;
    padding:7px 9px;
    background:linear-gradient(135deg,#22c55e1a,#16a34a1f);
    border:1px solid rgba(34,197,94,.45);
    font-size:11px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:8px;
  }
  .uap-banner span.label{
    display:flex;
    align-items:center;
    gap:6px;
    color:#166534;
  }
  .uap-banner span.label .icon{
    font-size:13px;
  }
  .uap-banner a{
    font-size:11px;
    padding:3px 7px;
    border-radius:999px;
    border:1px solid rgba(22,163,74,.6);
    background:#ecfdf5;
    color:#166534;
    text-decoration:none;
    display:inline-flex;
    align-items:center;
    gap:4px;
  }
  .uap-banner a:hover{
    background:#bbf7d0;
  }

  .actions-bottom{
    margin-top:8px;
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:8px;
  }
  .bottom-nav{
    display:flex;
    gap:6px;
  }
  .nav-main-btn{
    border-radius:999px;
    padding:6px 12px;
    font-size:12px;
    border:1px solid rgba(148,163,184,.7);
    background:linear-gradient(135deg,#eff6ff,#dbeafe);
    display:inline-flex;
    align-items:center;
    gap:7px;
    cursor:pointer;
    box-shadow:var(--shadow-sm);
  }
  .nav-main-btn span.icon{
    font-size:14px;
  }
  .nav-main-btn:hover{
    background:linear-gradient(135deg,#dbeafe,#bfdbfe);
  }
  .nav-sub-btn{
    border-radius:999px;
    padding:5px 10px;
    font-size:11px;
    border:1px solid rgba(148,163,184,.6);
    background:#f9fafb;
    display:inline-flex;
    align-items:center;
    gap:5px;
    cursor:pointer;
  }
  .nav-sub-btn span.icon{
    font-size:12px;
  }
  .nav-sub-btn:hover{
    background:#e5e7eb;
  }

  .tts-controls{
    display:flex;
    align-items:center;
    gap:6px;
  }
  .tts-btn{
    border-radius:999px;
    padding:4px 9px;
    font-size:11px;
    border:1px solid rgba(148,163,184,.7);
    background:rgba(248,250,252,.9);
    display:inline-flex;
    align-items:center;
    gap:5px;
    cursor:pointer;
  }
  .tts-btn span.icon{
    font-size:12px;
  }
  .tts-btn.is-active{
    background:rgba(37,99,235,.08);
    color:#1d4ed8;
    border-color:rgba(129,140,248,.95);
  }

  .decisions-box{
    margin-top:6px;
    border-radius:11px;
    padding:7px 9px;
    border:1px solid rgba(148,163,184,.5);
    background:rgba(248,250,252,.85);
    font-size:11px;
  }
  .decisions-box h4{
    margin:0 0 5px;
    font-size:11px;
    text-transform:uppercase;
    letter-spacing:.08em;
    color:#64748b;
  }
  .decision-list{
    margin:0;
    padding-left:18px;
  }
  .decision-list li{
    margin-bottom:2px;
  }

  .bubble{
    border-radius:999px;
    padding:3px 7px;
    font-size:11px;
    background:rgba(15,23,42,.03);
    border:1px solid rgba(148,163,184,.5);
  }

  .panel-footer{
    background:linear-gradient(90deg,rgba(15,23,42,.96),rgba(30,64,175,.96));
    border-top:1px solid rgba(15,23,42,.95);
    padding:7px 11px;
    font-size:11px;
    color:#e5e7eb;
    display:flex;
    justify-content:space-between;
    align-items:center;
  }
  .panel-footer .left{
    display:flex;
    gap:8px;
    align-items:center;
  }
  .panel-footer .left span.icon{
    font-size:13px;
  }
  .panel-footer .right{
    opacity:.85;
  }

  .pill{
    border-radius:999px;
    padding:2px 7px;
    border:1px solid rgba(148,163,184,.8);
    display:inline-flex;
    align-items:center;
    gap:5px;
    background:rgba(15,23,42,.4);
  }

  .read-overlay{
    position:fixed;
    inset:0;
    background:rgba(15,23,42,.55);
    display:none;
    align-items:flex-start;
    justify-content:center;
    z-index:40;
    padding:20px 14px;
  }
  .read-overlay.open{
    display:flex;
  }
  .read-dialog{
    max-width:640px;
    width:100%;
    border-radius:18px;
    background:#f9fafb;
    box-shadow:0 20px 60px rgba(15,23,42,.6);
    border:1px solid rgba(148,163,184,.7);
    overflow:hidden;
  }
  .read-header{
    padding:10px 14px 8px;
    display:flex;
    justify-content:space-between;
    align-items:center;
    background:linear-gradient(135deg,#111827,#020617);
    color:#e5e7eb;
  }
  .read-header h2{
    margin:0;
    font-size:13px;
    font-weight:600;
  }
  .read-header button{
    border-radius:999px;
    border:none;
    background:rgba(15,23,42,.3);
    color:#e5e7eb;
    padding:3px 8px;
    font-size:11px;
    cursor:pointer;
  }
  .read-body{
    max-height:420px;
    overflow:auto;
    padding:12px 14px 12px;
    font-size:13px;
    line-height:1.55;
    color:#020617;
  }

  @media (max-width:900px){
    .main-layout{
      grid-template-columns:1fr;
    }
  }
</style>

<div class="wrap">
  <header class="appbar">
    <div class="brand-left">
      <div class="logo-badge">
        <div class="logo-badge-inner">SE</div>
      </div>
      <div class="brand-text">
        <h1>Line Entry Options</h1>
        <p>Interactive SOP Story ‚Ä¢ Sales Order Line Entry</p>
      </div>
    </div>
    <div class="app-actions">
      <div class="pill-status">
        <span class="pill-dot"></span>
        <span>Training Environment ‚Ä¢ Ready</span>
      </div>
      <div class="nav-buttons">
        <button class="nav-btn" onclick="goEntityMenu()">
          <span class="icon">üè¢</span>
          <span>Entity Menu</span>
        </button>
        <button class="nav-btn" onclick="goHome()">
          <span class="icon">üè†</span>
          <span>Home</span>
        </button>
        <button class="nav-btn danger" onclick="goExit()">
          <span class="icon">‚úï</span>
          <span>Exit</span>
        </button>
      </div>
    </div>
  </header>

  <div class="main-layout">
    <section class="left-panel">
      <div class="frame-img-wrap">
        <div class="frame-img-ghost"></div>
        <div class="frame-img-inner">
          <img id="frame-img" src="" alt="Line Entry Step" />
          <div class="frame-img-caption">
            <span><span class="icon">üñ•Ô∏è</span> <span id="frame-caption">Loading frame‚Ä¶</span></span>
            <span class="icon" id="frame-step-tag">Step ?</span>
          </div>
        </div>
      </div>
      <div class="frame-meta-bar">
        <div class="meta-left">
          <div class="badge"><span class="dot"></span><span id="frame-meta-code">Code ?</span></div>
          <span id="frame-meta-type">Type: Step</span>
        </div>
        <div class="meta-right">
          <span id="frame-meta-path">Image: ‚Äî</span>
          <span id="frame-meta-node">Node: ‚Äî</span>
        </div>
      </div>
      <div class="panel-footer">
        <div class="left">
          <span class="icon">üí°</span>
          <span>Tip: You can open the full narration or a decision map from the right-hand panel.</span>
        </div>
        <div class="right">
          <span class="pill"><span class="icon">üìä</span> Line Entry Decision Map</span>
        </div>
      </div>
    </section>

    <section class="right-panel">
      <div class="right-panel-inner">
        <div class="crumbs" id="breadcrumbs">
          <span class="step-code-pill" id="crumb-step">Code ?</span>
          <span class="sep">‚Ä∫</span>
          <span id="crumb-title">Loading‚Ä¶</span>
        </div>

        <div class="title-row">
          <div class="title-main" id="title-main">Loading step‚Ä¶</div>
          <div class="title-tag">
            <span class="icon">üìë</span>
            <span id="title-tag">Line Entry SOP</span>
          </div>
        </div>

        <div class="narr-box">
          <h3>What happens in this step?</h3>
          <p id="narr-main">‚Ä¶</p>
        </div>

        <div class="narr-secondary">
          <strong>Context &amp; guidance:</strong>
          <span id="narr-secondary">‚Ä¶</span>
        </div>

        <div class="uap-banner" id="uap-banner" style="display:none;">
          <span class="label">
            <span class="icon">üéì</span>
            <span id="uap-label">Linked UAP</span>
          </span>
          <a id="uap-link" href="#" target="_blank" rel="noopener">
            Open training UAP <span class="icon">‚Üó</span>
          </a>
        </div>

        <div class="decisions-box">
          <h4>Decisions &amp; next steps</h4>
          <ul class="decision-list" id="decision-list"></ul>
        </div>

        <div class="actions-bottom">
          <div class="bottom-nav">
            <button class="nav-main-btn" onclick="gotoNextPrimary()">
              <span class="icon">‚û°Ô∏è</span>
              <span id="primary-next-label">Next step</span>
            </button>
            <button class="nav-sub-btn" onclick="gotoPrev()">
              <span class="icon">‚¨ÖÔ∏è</span>
              <span>Back</span>
            </button>
            <button class="nav-sub-btn" onclick="restart()">
              <span class="icon">üîÅ</span>
              <span>Restart flow</span>
            </button>
          </div>

          <div class="tts-controls">
            <button class="tts-btn" id="btn-read1" onclick="openRead('read1')">
              <span class="icon">üóÇÔ∏è</span>
              <span>Read step details</span>
            </button>
            <button class="tts-btn" id="btn-read2" onclick="openRead('read2')">
              <span class="icon">üß≠</span>
              <span>View decision map</span>
            </button>
          </div>
        </div>
      </div>
    </section>
  </div>
</div>

<div class="read-overlay" id="read1">
  <div class="read-dialog">
    <div class="read-header">
      <h2 id="read1-title">Step details</h2>
      <button onclick="closeRead('read1')">Close ‚úï</button>
    </div>
    <div class="read-body" id="read1-body"></div>
  </div>
</div>

<div class="read-overlay" id="read2">
  <div class="read-dialog">
    <div class="read-header">
      <h2>Line Entry Option ‚Äì decision map</h2>
      <button onclick="closeRead('read2')">Close ‚úï</button>
    </div>
    <div class="read-body" id="read2-body">
      <!-- populated by script -->
    </div>
  </div>
</div>

<script>
const CONFIG = {
  showBreadcrumb: true,
  showDetails: false,

  // When you click the "Exit" icon in the top bar
  exitHref: "index.html",

  // "Entity Menu" button ‚Äì jump to the Electrical Distribution card
  entityHref: "index.html#entity-distro",

  // "Home" button ‚Äì go to top of landing page
  homeHref: "index.html"
};

// Project-aware absolute path helper:
// Resolve relative to this HTML file's directory (e.g. /EdxBuild/site/BUILD)
function toAbsolute(p){
  // directory of the current page, e.g. /EdxBuild/site/BUILD
  const base = location.pathname.replace(/\/[^\/]*$/, "");
  return p.startsWith("/") ? (base + p) : (base + "/" + p);
}

let data=null, byCode={}, historyStack=[], speakingId=null;
const imgEl=document.getElementById("frame-img");
const capEl=document.getElementById("frame-caption");
const metaCodeEl=document.getElementById("frame-meta-code");
const metaTypeEl=document.getElementById("frame-meta-type");
const metaPathEl=document.getElementById("frame-meta-path");
const metaNodeEl=document.getElementById("frame-meta-node");
const crumbStepEl=document.getElementById("crumb-step");
const crumbTitleEl=document.getElementById("crumb-title");
const titleMainEl=document.getElementById("title-main");
const narrMainEl=document.getElementById("narr-main");
const narrSecondaryEl=document.getElementById("narr-secondary");
const primaryNextLabelEl=document.getElementById("primary-next-label");
const decisionListEl=document.getElementById("decision-list");
const uapBannerEl=document.getElementById("uap-banner");
const uapLabelEl=document.getElementById("uap-label");
const uapLinkEl=document.getElementById("uap-link");

// Load story JSON from the same folder as this HTML
async function load(){
  try{
    const url = "story/LineEnt_story.json";
    const res = await fetch(url);
    if(!res.ok) throw new Error("HTTP "+res.status);
    data = await res.json();
    if(data.frames){
      data.frames.forEach(f=>{
        if(f.frame_code){
          byCode[f.frame_code]=f;
        }
      });
    }
    const start = data.start_code || (data.frames[0] && data.frames[0].frame_code);
    historyStack=[start];
    render(start);
  }catch(err){
    console.error("Failed to load story:",err);
    capEl.textContent="Could not load story data";
  }
}

function render(code){
  const f=byCode[code];
  if(!f) return;
  // image path
  const imgPath = f.image_path || f.image;
  if(imgPath){
    imgEl.src = toAbsolute(imgPath);
    imgEl.alt = f.title || f.caption || "Slide "+code;
    metaPathEl.textContent = "Image: "+imgPath;
  }else{
    imgEl.removeAttribute("src");
    imgEl.alt = "No slide image";
    metaPathEl.textContent = "Image: (none)";
  }

  const label = (f.frame_code || code) + (f.step_code ? " ‚Ä¢ "+f.step_code : "");
  document.getElementById("frame-step-tag").textContent = label;
  metaCodeEl.textContent = "Step "+(f.step_code || f.frame_code || code);
  metaNodeEl.textContent = "Node: "+(f.node_type || "Standard");

  crumbStepEl.textContent = f.step_code || f.frame_code || code;
  crumbTitleEl.textContent = f.title || "Untitled step";

  titleMainEl.textContent = f.title || "Line Entry step";

  narrMainEl.textContent = f.narr_main || f.narr1 || "";
  narrSecondaryEl.textContent = f.narr_secondary || f.narr2 || "";

  // UAP
  if(f.uap_url){
    uapBannerEl.style.display="";
    uapLabelEl.textContent = f.uap_label || "Linked UAP";
    uapLinkEl.href = f.uap_url;
  }else{
    uapBannerEl.style.display="none";
  }

  // Next decisions
  decisionListEl.innerHTML="";
  const options = [];
  if(f.next_primary){
    options.push({label:f.next_primary_label || "Next step", code:f.next_primary});
  }
  if(f.next_alt1){
    options.push({label:f.next_alt1_label || "Alternate path 1", code:f.next_alt1});
  }
  if(f.next_alt2){
    options.push({label:f.next_alt2_label || "Alternate path 2", code:f.next_alt2});
  }
  options.forEach(o=>{
    const li = document.createElement("li");
    const a = document.createElement("a");
    a.href="#";
    a.textContent = o.label+" ("+o.code+")";
    a.onclick = (ev)=>{ev.preventDefault(); gotoCode(o.code);};
    li.appendChild(a);
    decisionListEl.appendChild(li);
  });
  if(options.length){
    primaryNextLabelEl.textContent = options[0].label;
  }else{
    primaryNextLabelEl.textContent = "No next step";
  }
}

function gotoCode(code){
  if(!byCode[code]) return;
  historyStack.push(code);
  render(code);
}
function gotoNextPrimary(){
  const curCode = historyStack[historyStack.length-1];
  const f = byCode[curCode];
  if(f && f.next_primary){
    gotoCode(f.next_primary);
  }
}
function gotoPrev(){
  if(historyStack.length>1){
    historyStack.pop();
    render(historyStack[historyStack.length-1]);
  }
}
function restart(){
  if(!data) return;
  stopTTS();
  const s=data.start_code || (data.frames[0] && data.frames[0].frame_code);
  historyStack=[s];
  render(s);
}

function goExit(){
  stopTTS();
  if(CONFIG.exitHref){
    location.href = CONFIG.exitHref;
  }
}
function goEntityMenu(){
  stopTTS();
  if(CONFIG.entityHref){
    location.href = CONFIG.entityHref;
  }
}
function goHome(){
  stopTTS();
  if(CONFIG.homeHref){
    location.href = CONFIG.homeHref;
  }
}

// simple TTS placeholders in case you wire them later
function stopTTS(){ speakingId=null; }
function openRead(which){
  const ov = document.getElementById(which);
  if(!ov) return;
  if(which==="read1"){
    const curCode = historyStack[historyStack.length-1];
    const f = byCode[curCode];
    document.getElementById("read1-title").textContent = f.title || "Step details";
    document.getElementById("read1-body").textContent =
      (f.narr_full || f.narr_main || f.narr1 || "") + "\n\n" +
      (f.narr_secondary || f.narr2 || "");
  }else if(which==="read2"){
    const lines = [];
    if(data && data.frames){
      data.frames.forEach(fr=>{
        lines.push((fr.frame_code || "?") + " ‚Äì " + (fr.title || ""));
      });
    }
    document.getElementById("read2-body").textContent = lines.join("\n");
  }
  ov.classList.add("open");
}
function closeRead(which){
  const ov = document.getElementById(which);
  if(ov) ov.classList.remove("open");
}

document.addEventListener('keydown',(e)=>{
  if(e.key==='Escape'){
    closeRead('read1');
    closeRead('read2');
  }
});
load();
</script>
